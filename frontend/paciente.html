<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Paciente</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
</head>

<!-- Modal de Videollamada con coraz√≥n latiente -->
<div id="vc-overlay" class="overlay" style="display:none" role="dialog" aria-modal="true" aria-labelledby="vc-title">
  <div class="popup">
    <div class="heart-wrap" aria-hidden="true">
      <!-- SVG coraz√≥n -->
      <svg class="heart" viewBox="0 0 24 24" fill="#7ff7e6" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 21s-6.716-4.22-9.193-8.006C.59 9.77 1.43 6.34 4.2 5.2c2.02-.85 4.37-.07 5.8 1.45 1.43-1.52 3.78-2.3 5.8-1.45 2.77 1.14 3.61 4.57 1.39 7.794C18.716 16.78 12 21 12 21z"/>
      </svg>
    </div>

    <h2 id="vc-title">Conectando con tu enfermera‚Ä¶</h2>
    <div class="progress-dots" aria-hidden="true">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
    <p>Tu enfermera se conectar√° en breve. Mientras esperas, revisa tus recordatorios de medicaci√≥n:</p>

    <div id="vc-pills" class="pills" aria-live="polite">
      <!-- aqu√≠ se insertan los recordatorios -->
    </div>

    <div class="modal-actions">
      <button class="btn-ghost" onclick="cerrarVC()">Cancelar</button>
      <button class="btn-primary" onclick="cerrarVC()">Aceptar</button>
    </div>
  </div>
</div>

<script>
  // Si ya usas app.js, respeta el API_URL global; si no, setea el de Render:
  const API_URL = window.API_URL || "https://enfermeriaaunclick-cem.onrender.com/api";

  async function videollamada(){
    // (1) Crea la solicitud en backend si est√° disponible
    try {
      const nombre = localStorage.getItem("nombrePaciente") || "Paciente";
      await fetch(`${API_URL}/videollamadas`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ paciente: nombre })
      });
    } catch(e) {
      console.warn("No se pudo registrar la videollamada (modo demo o sin red).", e);
    }

    // (2) Carga recordatorios y muestra modal
    await cargarRecordatoriosEnModal();
    abrirVC();

    // (3) Cierre autom√°tico suave (opcional)
    window.__vcTimer && clearTimeout(window.__vcTimer);
    window.__vcTimer = setTimeout(() => cerrarVC(), 8000);
  }

  function abrirVC(){ document.getElementById("vc-overlay").style.display = "flex"; }
  function cerrarVC(){ 
    document.getElementById("vc-overlay").style.display = "none"; 
    window.__vcTimer && clearTimeout(window.__vcTimer);
  }

  async function cargarRecordatoriosEnModal(){
    const cont = document.getElementById("vc-pills");
    cont.innerHTML = `<div class="pill">Cargando recordatorios‚Ä¶</div>`;
    try {
      const res = await fetch(`${API_URL}/recordatorios`, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      if(!data || !data.length){
        cont.innerHTML = `<div class="pill">No hay recordatorios por ahora.</div>`;
        return;
      }

      cont.innerHTML = data.map(r => `
        <div class="pill">
          <div><strong>${r.medicamento}</strong></div>
          <span>${r.hora}</span>
        </div>
      `).join("");
    } catch(err){
      cont.innerHTML = `
        <div class="pill">
          No se pudieron cargar recordatorios. <span>Intenta m√°s tarde</span>
        </div>`;
      console.error(err);
    }
  }
</script>

<body class="dashboard">
  <header>
    <h2>üëã Hola, Mar√≠a</h2>
    <p>Tu enfermera asignada: <strong>Ana P√©rez</strong></p>
  </header>

  <section class="cards">
    <div class="card" onclick="alerta()">
      <h3>üí¨ Chat con mi enfermera</h3>
      <p>Enviar mensaje o revisar seguimiento</p>
    </div>

    <div class="card" onclick="videollamada()">
      <h3>üìû Videollamada</h3>
      <p>Conectarte con tu enfermera</p>
    </div>

    <div class="card">
      <h3>üíä Recordatorios</h3>
      <p>Losart√°n 50mg ‚Äî 8:00 a.m.</p>
      <p>Metformina 500mg ‚Äî 12:00 p.m.</p>
    </div>

    <div class="card">
      <h3>‚ö†Ô∏è Recomendaci√≥n del d√≠a</h3>
      <p>Recuerda hidratarte y medir tu glucosa antes del desayuno.</p>
    </div>
  </section>

  <footer>
    <a href="login.html">Cerrar sesi√≥n</a>
  </footer>

  <script>
    function videollamada() {
      const overlay = document.createElement("div");
      overlay.classList.add("overlay");
      overlay.innerHTML = `
        <div class="popup">
          <h2>üìû Conectando con tu enfermera...</h2>
          <p>Tu enfermera se conectar√° en breve contigo ‚ù§Ô∏è</p>
          <button onclick="this.parentNode.parentNode.remove()">Cerrar</button>
        </div>`;
      document.body.appendChild(overlay);
    }
    function alerta(){
      alert("Tu enfermera ha revisado tus signos vitales. ¬°Excelente progreso!");
    }
  </script>
</body>
</html>
